rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ” Helper Functions
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() &&
             (request.auth.token.role == 'admin' ||
              request.auth.token.isAdmin == true ||
              request.auth.token.admin == true);
    }

    function isPartner() {
      return isSignedIn() &&
             (request.auth.token.role == 'partner' || isAdmin());
    }

    function isSelf(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ‘¤ USERS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /users/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid);

      allow update: if isSelf(uid)
                    && !("role" in request.resource.data)
                    && !("isAdmin" in request.resource.data);

      allow delete: if isSelf(uid) || isAdmin();
      allow write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ§‘â€ğŸ’¼ PARTNERS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /partners/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid);

      allow update: if isSelf(uid)
                    && !("role" in request.resource.data)
                    && !("isAdmin" in request.resource.data);

      allow delete: if isSelf(uid) || isAdmin();

      /* KYC Docs */
      match /kycDocs/{docId} {
        allow read: if isSelf(uid) || isAdmin();
        allow create: if isSelf(uid);
        allow update, delete: if isAdmin();
      }

      /* KYC Audit */
      match /kycAudit/{auditId} {
        allow read: if isSelf(uid) || isAdmin();
        allow create: if isSelf(uid) || isAdmin();
        allow update, delete: if isAdmin();
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ“… BOOKINGS (FULLY FIXED)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /bookings/{bookingId} {

      // USER dashboard queries
      allow read: if isSignedIn()
                  && request.query != null
                  && request.query.where[0].field == "userId"
                  && request.query.where[0].value == request.auth.uid;

      // PARTNER dashboard queries
      allow read: if isSignedIn()
                  && request.query != null
                  && request.query.where[0].field == "partnerId"
                  && request.query.where[0].value == request.auth.uid;

      // Admin global access
      allow read: if isAdmin();

      allow create: if isSignedIn()
                    && request.resource.data.userId == request.auth.uid;

      allow update: if isAdmin()
                    || (isSignedIn() && resource.data.userId == request.auth.uid)
                    || (isSignedIn() && resource.data.partnerId == request.auth.uid);

      allow delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ’³ PAYMENTS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /payments/{paymentId} {
      allow read: if isSignedIn()
                  && (resource.data.userId == request.auth.uid
                      || resource.data.partnerId == request.auth.uid)
                  || isAdmin();

      allow create, update, delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ’¸ REFUNDS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /refunds/{refundId} {
      allow read: if isSignedIn()
                  && (resource.data.userId == request.auth.uid
                      || resource.data.partnerId == request.auth.uid)
                  || isAdmin();

      allow create: if isSelf(request.resource.data.userId);

      allow update: if isSelf(resource.data.userId);
      allow delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ’° SETTLEMENTS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /settlements/{sid} {

      allow read: if isAdmin()
                  || (isSignedIn()
                      && resource.data.partnerId == request.auth.uid);

      allow create: if isPartner()
                    && request.resource.data.partnerId == request.auth.uid;

      allow update: if isSignedIn()
                    && resource.data.partnerId == request.auth.uid;

      allow delete, write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       âš–ï¸ SETTLEMENT DISPUTES
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /settlement_disputes/{disputeId} {

      allow read: if isAdmin()
                  || (isSignedIn()
                      && resource.data.partnerId == request.auth.uid);

      allow create: if isPartner()
                    && request.resource.data.partnerId == request.auth.uid;

      allow update: if isSelf(resource.data.partnerId);
      allow delete: if isAdmin();

      match /messages/{msgId} {
        allow read: if isAdmin()
                    || (isSignedIn()
                        && get(/databases/$(database)/documents/settlement_disputes/$(disputeId))
                           .data.partnerId == request.auth.uid);

        allow create: if isAdmin()
                      || (isSignedIn()
                          && request.resource.data.uid == request.auth.uid);

        allow update, delete: if isAdmin();
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ”” NOTIFICATIONS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /notifications/{id} {
      allow read: if isSelf(resource.data.userId) || isAdmin();
      allow update: if isSelf(resource.data.userId);
      allow delete, write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â­ REVIEWS / STORIES
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /reviews/{id} {
      allow read: if true;
      allow create: if isSelf(request.resource.data.userId);
      allow update, delete: if isSelf(resource.data.userId);
    }

    match /stories/{id} {
      allow read: if true;
      allow create: if isSelf(request.resource.data.userId);
      allow update, delete: if isSelf(resource.data.userId);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ REFERRALS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /referrals/{rid} {
      allow read: if isAdmin()
                  || isSelf(resource.data.referrerId)
                  || isSelf(resource.data.referredUserId);

      allow create: if isSelf(request.resource.data.referrerId);
      allow update, delete: if isAdmin();
    }

    match /referral_codes/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid)
                    && !exists(/databases/$(database)/documents/referral_codes/$(uid));
      allow update, delete: if isAdmin();
    }

    match /rewards/{rewardId} {
      allow read: if isSelf(resource.data.userId) || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    match /users/{uid}/wallet/{entryId} {
      allow read: if isSelf(uid) || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ  PUBLIC DOCUMENTS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /homepage/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /listings/{id} {
      allow read: if true;
      allow write, delete: if isAdmin();
    }

    match /featured_listings/{id} {
      allow read: if true;
      allow write, delete: if isAdmin();
    }

    match /promotions/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /trending_destinations/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /recent_stories/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
