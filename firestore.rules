rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ” Helper Functions
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() &&
             (request.auth.token.role == 'admin' ||
              request.auth.token.isAdmin == true);
    }

    function isPartner() {
      return isSignedIn() &&
             (request.auth.token.role == 'partner' || isAdmin());
    }

    function isSelf(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ‘¤ Users
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /users/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid);

      allow update: if isSelf(uid) &&
                    !(("role" in request.resource.data) ||
                      ("isAdmin" in request.resource.data)) &&
                    request.resource.data.uid == uid;

      allow delete: if isSelf(uid) || isAdmin();
      allow write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ§‘â€ğŸ’¼ Partners
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /partners/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid);

      allow update: if isSelf(uid) &&
                    !(("role" in request.resource.data) ||
                      ("isAdmin" in request.resource.data));

      allow delete: if isSelf(uid) || isAdmin();
      allow write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ“… BOOKINGS (Fully Fixed)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /bookings/{bookingId} {

      function isBookingOwner() {
        return isSignedIn() &&
               resource.data.userId == request.auth.uid;
      }

      function isBookingPartner() {
        return isSignedIn() &&
               resource.data.partnerId == request.auth.uid;
      }

      // LIST QUERIES FIX (Critical)
      allow list: if isSignedIn() || isAdmin();

      allow read: if isBookingOwner() || isBookingPartner() || isAdmin();

      allow create: if isSignedIn() &&
                     request.resource.data.userId == request.auth.uid;

      // Allow owner, partner OR admin to update
      allow update: if isAdmin()
                    || isBookingOwner()
                    || isBookingPartner();

      allow delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ’³ PAYMENTS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /payments/{paymentId} {

      function isRelated() {
        return isSignedIn() &&
               (resource.data.userId == request.auth.uid ||
                resource.data.partnerId == request.auth.uid);
      }

      allow list: if isSignedIn() || isAdmin();

      allow read: if isRelated() || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ’¸ REFUNDS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /refunds/{refundId} {

      function isRefundOwner() {
        return isSignedIn() &&
               resource.data.userId == request.auth.uid;
      }

      function isRefundPartner() {
        return isSignedIn() &&
               resource.data.partnerId == request.auth.uid;
      }

      allow list: if isSignedIn() || isAdmin();

      allow read: if isRefundOwner() || isRefundPartner() || isAdmin();

      allow create: if isSignedIn() &&
                     request.resource.data.userId == request.auth.uid;

      allow update: if isRefundOwner();
      allow delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ’° SETTLEMENTS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /settlements/{sid} {

      function isSettlementOwner() {
        return isSignedIn() &&
               resource.data.partnerId == request.auth.uid;
      }

      allow list: if isSignedIn() || isAdmin();

      allow read: if isSettlementOwner() || isAdmin();

      allow create: if isPartner() &&
                     request.resource.data.partnerId == request.auth.uid;

      allow update: if isSettlementOwner();

      allow delete, write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       âš–ï¸ SETTLEMENT DISPUTES
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /settlement_disputes/{disputeId} {

      allow read: if isAdmin() ||
                  (isSignedIn() &&
                   resource.data.partnerId == request.auth.uid);

      allow create: if isPartner() &&
                     request.resource.data.partnerId == request.auth.uid;

      allow update: if isSignedIn() &&
                     resource.data.partnerId == request.auth.uid;

      allow delete: if isAdmin();

      match /messages/{msgId} {
        allow read: if isAdmin() ||
                    (isSignedIn() &&
                     get(/databases/$(database)/documents/settlement_disputes/$(disputeId))
                       .data.partnerId == request.auth.uid);

        allow create: if isAdmin() ||
                       (isSignedIn() &&
                        request.resource.data.uid == request.auth.uid);

        allow delete, update: if isAdmin();
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ”” NOTIFICATIONS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /notifications/{id} {
      function isOwnerNotification() {
        return isSignedIn() &&
               resource.data.userId == request.auth.uid;
      }

      allow read: if isOwnerNotification() || isAdmin();

      allow update: if isOwnerNotification();

      allow delete, write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â­ REVIEWS / STORIES
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /reviews/{id} {
      allow read: if true;
      allow create: if isSignedIn() &&
                     request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() &&
                             resource.data.userId == request.auth.uid;
    }

    match /stories/{id} {
      allow read: if true;
      allow create: if isSignedIn() &&
                     request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() &&
                             resource.data.userId == request.auth.uid;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ REFER & EARN
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /referrals/{rid} {

      function isReferrer() {
        return isSignedIn() &&
               resource.data.referrerId == request.auth.uid;
      }

      function isReferred() {
        return isSignedIn() &&
               resource.data.referredUserId == request.auth.uid;
      }

      allow read: if isReferrer() || isReferred() || isAdmin();

      allow create: if isSignedIn() &&
                     request.resource.data.referrerId == request.auth.uid;

      allow update, delete: if isAdmin();
    }

    match /referral_codes/{uid} {
      allow read: if isSelf(uid) || isAdmin();

      allow create: if isSelf(uid) &&
                     !exists(/databases/$(database)/documents/referral_codes/$(uid));

      allow update, delete: if isAdmin();
    }

    match /rewards/{rewardId} {
      function isRewardOwner() {
        return isSignedIn() &&
               resource.data.userId == request.auth.uid;
      }

      allow read: if isRewardOwner() || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    match /users/{uid}/wallet/{entryId} {
      allow read: if isSelf(uid) || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ  HOMEPAGE + LISTINGS (PUBLIC)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /homepage/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /listings/{id} {
      allow read: if true;
      allow write, delete: if isAdmin();
    }

    match /featured_listings/{id} {
      allow read: if true;
      allow write, delete: if isAdmin();
    }

    match /promotions/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /trending_destinations/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /recent_stories/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
