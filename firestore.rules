rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ================================
       ğŸ” HELPER FUNCTIONS
    ================================= */
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() &&
        (request.auth.token.role == 'admin' ||
         request.auth.token.role == 'superadmin' ||
         request.auth.token.isAdmin == true ||
         request.auth.token.admin == true);
    }

    function isPartner() {
      return isSignedIn() && request.auth.token.role == 'partner';
    }

    function isStaff() {
      return isSignedIn() && request.auth.token.role == 'staff';
    }

    function isSelf(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    /* ================================
       âœ… PUBLIC PARTNER LEADS (FORM)
    ================================= */
    match /partnerLeads/{docId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    /* ================================
       ğŸ‘¤ USERS
    ================================= */
    match /users/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid);
      allow update: if isSelf(uid)
        && !(request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(["role","isAdmin","status","isActive"]));
      allow delete: if isAdmin();
    }

    match /users/{uid}/wallet/{entryId} {
      allow read: if isSelf(uid) || isAdmin();
      allow write, delete: if isAdmin();
    }

    /* ================================
     /* ================================
   ğŸ¤ PARTNERS + KYC (âœ… FINAL FIX)
================================ */
match /partners/{uid} {

  // âœ… Partner apna data padh sakta hai
  allow read: if isSelf(uid);

  // âœ… Admin kisi bhi partner ko padh sakta hai
  allow read: if isAdmin();

  // âœ… Partner khud ka profile create kar sakta hai
  allow create: if isSelf(uid);

  // âœ… Partner limited fields update kar sakta hai
  allow update: if isSelf(uid)
    && !("role" in request.resource.data)
    && !("isAdmin" in request.resource.data)
    && !("kycStatus" in request.resource.data)
    && !("approved" in request.resource.data);

  // âœ…âœ… ADMIN FULL CONTROL (ğŸ”¥ THIS IS THE REAL FIX)
  allow update, delete: if isAdmin();

  /* -------- KYC DOCUMENTS -------- */
  match /kycDocs/{docId} {

    // âœ… Partner khud ka KYC dekh sakta hai
    allow read: if isSelf(uid);

    // âœ… Admin sabka KYC dekh sakta hai
    allow read: if isAdmin();

    // âœ… Partner KYC submit kar sakta hai
    allow create: if isSelf(uid);

    // âœ…âœ… ADMIN KYC APPROVE / REJECT (ğŸ”¥ THIS FIX)
    allow update, delete: if isAdmin();
  }

  /* -------- KYC AUDIT LOG -------- */
  match /kycAudit/{auditId} {
    allow read: if isSelf(uid) || isAdmin();
    allow create: if isAdmin();
    allow update, delete: if isAdmin();
  }
}
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ LISTINGS (ğŸ”¥ PARTNER FULL CONTROL) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /listings/{listingId} {
      allow read: if true;

      allow create: if isAdmin()
        || (isPartner() && request.resource.data.partnerId == request.auth.uid);

      allow update: if isAdmin()
        || (isPartner() && resource.data.partnerId == request.auth.uid);

      allow delete: if isAdmin()
        || (isPartner() && resource.data.partnerId == request.auth.uid);

      match /availability/{aid} {
        allow read: if true;
        allow write: if isAdmin()
          || (isPartner()
              && get(/databases/$(database)/documents/listings/$(listingId))
                  .data.partnerId == request.auth.uid);
      }
    }
    /* ================================
      /* ================================
   /* ================================
   ğŸ§‘â€ğŸ’¼ STAFF (LOGIN SAFE RESTORE)
================================ */
match /staff/{staffId} {

  // âœ… allow read AFTER auth session exists
  allow read: if request.auth != null;

  // âŒ client create not allowed
  allow create: if false;

  // âœ… staff limited self update
  allow update: if request.auth != null
    && request.auth.uid == staffId
    && !(request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(["role","status","isActive"]));

  // âœ… admin full control
  allow read, write, delete: if isAdmin();
}


    /* ================================
       âœ… TELECALLER LEADS (TASK SYSTEM)
    ================================= */
    match /leads/{leadId} {

      // âœ… Admin full control
      allow read, write, delete: if isAdmin();

      // âœ… Telecaller can read ONLY assigned leads
      allow read: if isStaff()
        && resource.data.assignedTo == request.auth.uid;

      // âœ… Telecaller can update ONLY limited fields
      allow update: if isStaff()
        && resource.data.assignedTo == request.auth.uid
        && request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly([
            "status",
            "partnerNotes",
            "notes",
            "followUpDate",
            "updatedAt"
          ]);

      // âŒ No client-side create
      allow create: if false;
    }

    /* ================================
       ğŸ“… BOOKINGS
    ================================= */
    match /bookings/{bookingId} {
      allow read: if isAdmin()
        || (isSignedIn() && resource.data.userId == request.auth.uid)
        || (isSignedIn() && resource.data.partnerId == request.auth.uid);

      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;

      allow update: if isAdmin()
        || (isSignedIn() && resource.data.userId == request.auth.uid)
        || (isSignedIn() && resource.data.partnerId == request.auth.uid);

      allow delete: if isAdmin();
    }

    /* ================================
       ğŸ’³ PAYMENTS
    ================================= */
    match /payments/{paymentId} {
      allow read: if isAdmin()
        || (isSignedIn() && resource.data.userId == request.auth.uid);

      allow write, delete: if isAdmin();
    }

    /* ================================
       ğŸ’¸ REFUNDS
    ================================= */
    match /refunds/{refundId} {
      allow read: if isAdmin()
        || (isSignedIn() && resource.data.userId == request.auth.uid);

      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;

      allow update: if isSignedIn()
        && resource.data.userId == request.auth.uid;

      allow delete: if isAdmin();
    }

    /* ================================
       ğŸ’° SETTLEMENTS
    ================================= */
    match /settlements/{sid} {
      allow read: if isAdmin()
        || (isSignedIn() && resource.data.partnerId == request.auth.uid);

      allow create: if isPartner()
        && request.resource.data.partnerId == request.auth.uid;

      allow update: if isSignedIn()
        && resource.data.partnerId == request.auth.uid;

      allow delete: if isAdmin();
    }

    /* ================================
       âš–ï¸ SETTLEMENT DISPUTES
    ================================= */
    match /settlement_disputes/{disputeId} {
      allow read: if isAdmin()
        || (isSignedIn() && resource.data.partnerId == request.auth.uid);

      allow create: if isPartner()
        && request.resource.data.partnerId == request.auth.uid;

      allow update: if isSignedIn()
        && resource.data.partnerId == request.auth.uid;

      allow delete: if isAdmin();

      match /messages/{msgId} {
        allow read: if isAdmin()
          || (isSignedIn()
            && get(/databases/$(database)/documents/settlement_disputes/$(disputeId))
              .data.partnerId == request.auth.uid);

        allow create: if isSignedIn()
          && request.resource.data.uid == request.auth.uid;

        allow update, delete: if isAdmin();
      }
    }

    /* ================================
       ğŸ”” NOTIFICATIONS
    ================================= */
    match /notifications/{id} {
      allow read: if isAdmin()
        || (isSignedIn() && resource.data.userId == request.auth.uid);

      allow update: if isSignedIn()
        && resource.data.userId == request.auth.uid;

      allow delete, write: if isAdmin();
    }

    /* ================================
       â­ REVIEWS / STORIES
    ================================= */
    match /reviews/{id} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn()
        && resource.data.userId == request.auth.uid;
    }

    match /stories/{id} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn()
        && resource.data.userId == request.auth.uid;
    }

    /* ================================
       ğŸ REFERRALS / REWARDS
    ================================= */
    match /referrals/{rid} {
      allow read: if isAdmin()
        || isSelf(resource.data.referrerId)
        || isSelf(resource.data.referredUserId);

      allow create: if isSignedIn()
        && request.resource.data.referrerId == request.auth.uid;

      allow update, delete: if isAdmin();
    }

    match /referral_codes/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid);
      allow update, delete: if isAdmin();
    }

    match /rewards/{rewardId} {
      allow read: if (isSignedIn()
        && resource.data.userId == request.auth.uid) || isAdmin();

      allow write, delete: if isAdmin();
    }

    /* ================================
       ğŸ  PUBLIC CMS / HOMEPAGE
    ================================= */
    match /homepage/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /featured_listings/{id} {
      allow read: if true;
      allow write, delete: if isAdmin();
    }

    match /promotions/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /trending_destinations/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /recent_stories/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /* ================================
       âŒ FINAL SECURITY LOCK
    ================================= */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
