######################################
# üöÄ BHARATCOMFORT11 ‚Äî Production Config (Final Dynamic Fix)
######################################

[build]
  command = "npm run build"
  publish = ".next"

######################################
# ‚öôÔ∏è Netlify Function Settings
######################################
[functions]
  node_bundler = "esbuild"
  external_node_modules = [
    "firebase-admin",
    "firebase",
    "nodemailer",
    "razorpay",
    "jspdf",
    "jspdf-autotable"
  ]
  included_files = [
    "lib/**/*",
    "app/api/**/*",
    "lib/invoices/**/*"
  ]

######################################
# üß© Next.js Plugin (Handles SSR + API Routes)
######################################
[[plugins]]
  package = "@netlify/plugin-nextjs"

######################################
# üåç Environment Settings (Dynamic Enforcer)
######################################
[build.environment]
  NODE_VERSION = "18"
  NEXT_DISABLE_ENV_INJECTION = "true"
  FIREBASE_CONFIG = "true"
  TZ = "Asia/Kolkata"

  # üß† Force runtime execution everywhere
  NEXT_FORCE_DYNAMIC = "true"
  NEXT_DYNAMIC_NO_WARNING = "true"
  NEXT_SKIP_BUILD_STATIC_GENERATION = "true"
  NEXT_RUNTIME = "nodejs"
  NEXT_SHARP_PATH = "/opt/buildhome/node_modules/sharp"

  # Optional but recommended
  NODE_OPTIONS = "--max-old-space-size=4096"

######################################
# ‚úÖ DO NOT ADD ANY CUSTOM REDIRECTS
######################################
# The @netlify/plugin-nextjs plugin already sets up all dynamic routing:
#   /api/* ‚Üí /.netlify/functions/next_api
#   SSR + ISR for pages
# Custom redirects can break API or SSR behavior.

######################################
# üîç Quick Test after Deploy:
######################################
# ‚úÖ Visit:
#   https://your-site.netlify.app/api/health
# or
#   https://your-site.netlify.app/api/auth/session
#
# You should see a valid JSON response (no prerender warning)
######################################
