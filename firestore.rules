rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ” Helper Functions
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() &&
             (request.auth.token.role == 'admin' ||
              request.auth.token.isAdmin == true ||
              request.auth.token.admin == true);
    }

    function isPartner() {
      return isSignedIn() &&
             (request.auth.token.role == 'partner' || isAdmin());
    }

    function isSelf(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ‘¤ USERS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /users/{uid} {
      // Allow signed-in owner to read their profile OR admin
      allow read: if isSelf(uid) || isAdmin();

      allow create: if isSelf(uid);

      // Users may update their doc but cannot set role/isAdmin
      allow update: if isSelf(uid)
                    && !("role" in request.resource.data)
                    && !("isAdmin" in request.resource.data);

      allow delete: if isSelf(uid) || isAdmin();
      allow write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ§‘â€ğŸ’¼ PARTNERS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /partners/{uid} {
      // partner doc read: owner or admin
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid);

      // partner can update their profile (not admin fields)
      allow update: if isSelf(uid)
                    && !("role" in request.resource.data)
                    && !("isAdmin" in request.resource.data);

      allow delete: if isSelf(uid) || isAdmin();

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         KYC Subcollections
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      match /kycDocs/{docId} {
        allow read: if isSelf(uid) || isAdmin();
        allow create: if isSelf(uid);
        allow update, delete: if isAdmin();
      }

      match /kycAudit/{auditId} {
        allow read: if isSelf(uid) || isAdmin();
        allow create: if isSelf(uid) || isAdmin();
        allow update, delete: if isAdmin();
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ“… BOOKINGS (query-safe)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /bookings/{bookingId} {

      // allow query by userId: where("userId","==", request.auth.uid)
      allow read: if isSignedIn()
                   && request.query != null
                   && request.query.where.size() > 0
                   && request.query.where[0].field == "userId"
                   && request.query.where[0].value == request.auth.uid;

      // allow query by partnerId: where("partnerId","==", request.auth.uid)
      allow read: if isSignedIn()
                   && request.query != null
                   && request.query.where.size() > 0
                   && request.query.where[0].field == "partnerId"
                   && request.query.where[0].value == request.auth.uid;

      // admin may read all
      allow read: if isAdmin();

      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      allow update: if isAdmin()
                    || (isSignedIn() && resource.data.userId == request.auth.uid)
                    || (isSignedIn() && resource.data.partnerId == request.auth.uid);

      allow delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ’³ PAYMENTS (query-safe for owner)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /payments/{paymentId} {
      // allow reads when queried by userId
      allow read: if isSignedIn()
                   && request.query != null
                   && request.query.where.size() > 0
                   && request.query.where[0].field == "userId"
                   && request.query.where[0].value == request.auth.uid;

      // allow reads when queried by partnerId
      allow read: if isSignedIn()
                   && request.query != null
                   && request.query.where.size() > 0
                   && request.query.where[0].field == "partnerId"
                   && request.query.where[0].value == request.auth.uid;

      // fallback admin
      allow read: if isAdmin();

      allow create, update, delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ’¸ REFUNDS (query-safe)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /refunds/{refundId} {
      // allow queries by userId
      allow read: if isSignedIn()
                   && request.query != null
                   && request.query.where.size() > 0
                   && request.query.where[0].field == "userId"
                   && request.query.where[0].value == request.auth.uid;

      // allow queries by partnerId
      allow read: if isSignedIn()
                   && request.query != null
                   && request.query.where.size() > 0
                   && request.query.where[0].field == "partnerId"
                   && request.query.where[0].value == request.auth.uid;

      allow read: if isAdmin();

      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;

      allow delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ’° SETTLEMENTS (query-safe)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /settlements/{sid} {

      // allow query reads by partnerId
      allow read: if isSignedIn()
                   && request.query != null
                   && request.query.where.size() > 0
                   && request.query.where[0].field == "partnerId"
                   && request.query.where[0].value == request.auth.uid;

      // admin may read all
      allow read: if isAdmin();

      // create by partner themselves
      allow create: if isPartner()
                    && request.resource.data.partnerId == request.auth.uid;

      // owner can update their settlement doc
      allow update: if isSignedIn() && resource.data.partnerId == request.auth.uid;

      allow delete, write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       âš–ï¸ SETTLEMENT DISPUTES & messages
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /settlement_disputes/{disputeId} {
      allow read: if isAdmin()
                  || (isSignedIn() && resource.data.partnerId == request.auth.uid);

      allow create: if isPartner() && request.resource.data.partnerId == request.auth.uid;

      allow update: if isSignedIn() && resource.data.partnerId == request.auth.uid;

      allow delete: if isAdmin();

      match /messages/{msgId} {
        allow read: if isAdmin()
                    || (isSignedIn()
                        && get(/databases/$(database)/documents/settlement_disputes/$(disputeId))
                           .data.partnerId == request.auth.uid);

        allow create: if isAdmin()
                      || (isSignedIn() && request.resource.data.uid == request.auth.uid);

        allow update, delete: if isAdmin();
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ”” NOTIFICATIONS (query-safe)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /notifications/{id} {
      // allow queries that filter by userId == request.auth.uid
      allow read: if isSignedIn()
                   && request.query != null
                   && request.query.where.size() > 0
                   && request.query.where[0].field == "userId"
                   && request.query.where[0].value == request.auth.uid;

      allow read: if isAdmin();

      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;

      allow delete, write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â­ REVIEWS / STORIES (public reads)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /reviews/{id} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    match /stories/{id} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ REFERRALS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /referrals/{rid} {
      // allow queries that include referrerId or referredUserId filters
      allow read: if isAdmin()
                  || (isSignedIn() &&
                      request.query != null
                      && request.query.where.size() > 0
                      && (request.query.where[0].field == "referrerId" && request.query.where[0].value == request.auth.uid
                          || request.query.where[0].field == "referredUserId" && request.query.where[0].value == request.auth.uid)
                     )
                  || isSelf(resource.data.referrerId)
                  || isSelf(resource.data.referredUserId);

      allow create: if isSignedIn() && request.resource.data.referrerId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    match /referral_codes/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid)
                    && !exists(/databases/$(database)/documents/referral_codes/$(uid));
      allow update, delete: if isAdmin();
    }

    match /rewards/{rewardId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    match /users/{uid}/wallet/{entryId} {
      allow read: if isSelf(uid) || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ  PUBLIC DOCUMENTS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /homepage/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /listings/{id} {
      allow read: if true;
      allow write, delete: if isAdmin();
    }

    match /featured_listings/{id} {
      allow read: if true;
      allow write, delete: if isAdmin();
    }

    match /promotions/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /trending_destinations/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /recent_stories/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
