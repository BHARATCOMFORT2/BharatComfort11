// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isAdmin() { return isSignedIn() && request.auth.token.role == "admin"; }
    function isPartner() { return isSignedIn() && request.auth.token.role == "partner"; }
    function isStaff() { return isSignedIn() && request.auth.token.role == "staff"; }
    function isVerifiedUser() {
      return isSignedIn() &&
             request.auth.token.email_verified == true &&
             (request.auth.token.phone_number != null);
    }

    match /users/{userId} {
      allow read: if true;
      allow write, update, delete: if isVerifiedUser() && request.auth.uid == userId;
      allow read, write, delete: if isAdmin();
    }

    match /partners/{partnerId} {
      allow read: if true;
      allow write, update: if isPartner() && isVerifiedUser() && request.auth.uid == partnerId;
      allow read, write, delete: if isAdmin();
    }

    match /listings/{listingId} {
      allow read: if true;
      allow create: if (isPartner() && isVerifiedUser() &&
                        request.auth.uid == request.resource.data.createdBy) || isAdmin();
      allow update, delete: if (isPartner() && isVerifiedUser() &&
                                request.auth.uid == resource.data.createdBy) ||
                             isAdmin() || isStaff();
    }

    match /stays/{stayId} {
      allow read: if true;
      allow create: if isPartner() && isVerifiedUser() &&
                     request.auth.uid == request.resource.data.partnerId;
      allow update, delete: if (isPartner() && isVerifiedUser() &&
                                request.auth.uid == resource.data.partnerId) ||
                             isAdmin() || isStaff();
    }

    match /bookings/{bookingId} {
      allow read: if isAdmin() || isStaff();
      allow read: if isPartner() && request.auth.uid == resource.data.partnerId;
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow create: if (isVerifiedUser() && request.auth.uid == request.resource.data.userId) || isAdmin();
      allow update: if (isPartner() && isVerifiedUser() &&
                        request.auth.uid == resource.data.partnerId) || isAdmin();
      allow delete: if isAdmin();
    }

    match /payments/{paymentId} {
      allow create, read: if isVerifiedUser();
      allow update, delete: if isAdmin() || isStaff();
    }

    match /notifications/{notifId} {
      allow read: if isSignedIn() &&
        (resource.data.userId == request.auth.uid ||
         resource.data.userId == "all" || isAdmin() || isStaff());
      allow create: if isVerifiedUser();
      allow update, delete: if isAdmin() || isStaff();
    }

    match /homepage/{sectionId} {
      allow read: if true;
      allow create, write, update, delete: if isAdmin() || isStaff();
    }

    match /stories/{id} { allow read: if true; }
    match /destinations/{id} { allow read: if true; }
    match /promotions/{id} { allow read: if true; }
    match /offers/{id} { allow read: if true; }
    match /banners/{id} { allow read: if true; }
    match /faqs/{id} { allow read: if true; }
    match /pages/{id} { allow read: if true; }

    match /admin/{docId} { allow read, write, delete: if isAdmin(); }

    match /staffs/{staffId} {
      allow read: if isAdmin() || (isStaff() && request.auth.uid == staffId);
      allow write, update, delete: if isAdmin();
    }

    match /{document=**} { allow read, write: if false; }
  }
}
