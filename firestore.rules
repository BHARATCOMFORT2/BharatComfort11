rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ” Helper Functions
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() &&
             ((request.auth.token.role == 'admin') ||
              (request.auth.token.isAdmin == true));
    }

    function isPartner() {
      return isSignedIn() &&
             (request.auth.token.role == 'partner' || isAdmin());
    }

    function isSelf(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ‘¤ Users
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /users/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid);
      allow update: if isSelf(uid)
                    && !(("role" in request.resource.data) || ("isAdmin" in request.resource.data))
                    && (request.resource.data.uid == uid)
                    && (request.resource.data.email == resource.data.email);
      allow delete: if isSelf(uid) || isAdmin();
      allow write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ§‘â€ğŸ’¼ Partners
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /partners/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid);
      allow update: if isSelf(uid)
                    && !(("role" in request.resource.data) || ("isAdmin" in request.resource.data));
      allow delete: if isSelf(uid) || isAdmin();
      allow write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ“… Bookings
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /bookings/{bookingId} {
      function isBookingOwner() {
        return isSignedIn() && request.auth.uid == resource.data.userId;
      }
      function isBookingPartner() {
        return isSignedIn() && resource.data.partnerId == request.auth.uid;
      }

      allow read: if isBookingOwner() || isBookingPartner() || isAdmin();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if (isBookingOwner() &&
                        request.resource.data.keys().hasOnly(['status', 'cancellationReason', 'updatedAt']))
                    || (isBookingPartner() &&
                        request.resource.data.keys().hasOnly(['status', 'checkIn', 'checkOut', 'updatedAt', 'notes']));
      allow write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ’³ Payments
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /payments/{paymentId} {
      function isRelated() {
        return isSignedIn() &&
          (('userId' in resource.data && resource.data.userId == request.auth.uid) ||
           ('partnerId' in resource.data && resource.data.partnerId == request.auth.uid));
      }

      allow read: if isRelated() || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ’¸ Refunds
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /refunds/{refundId} {
      function isRefundOwner() {
        return isSignedIn() && resource.data.userId == request.auth.uid;
      }
      function isRefundPartner() {
        return isSignedIn() && resource.data.partnerId == request.auth.uid;
      }

      allow read: if isRefundOwner() || isRefundPartner() || isAdmin();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isRefundOwner() && request.resource.data.keys().hasOnly(['notes', 'updatedAt']);
      allow write, delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ’° Settlements
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /settlements/{settlementId} {
      function isSettlementOwner() {
        return isSignedIn() && resource.data.partnerId == request.auth.uid;
      }

      allow read: if isSettlementOwner() || isAdmin();
      allow create: if isPartner() && request.resource.data.partnerId == request.auth.uid;
      allow update: if isSettlementOwner() && request.resource.data.keys().hasOnly(['remark', 'updatedAt']);
      allow write, delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       âš–ï¸ Settlement Disputes
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /settlement_disputes/{disputeId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.partnerId == request.auth.uid);
      allow create: if isPartner() && request.resource.data.partnerId == request.auth.uid;
      allow update: if isSignedIn() &&
                    resource.data.partnerId == request.auth.uid &&
                    request.resource.data.keys().hasOnly(['description', 'fileUrl', 'updatedAt']);
      allow write, delete: if isAdmin();

      match /messages/{msgId} {
        allow read: if isAdmin()
                    || (isSignedIn() &&
                        get(/databases/$(database)/documents/settlement_disputes/$(disputeId)).data.partnerId == request.auth.uid);
        allow create: if isAdmin() || (isSignedIn() && request.resource.data.uid == request.auth.uid);
        allow update, delete: if isAdmin();
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ”” Notifications
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /notifications/{id} {
      function isOwnerNotification() {
        return isSignedIn() &&
               ('userId' in resource.data) &&
               resource.data.userId == request.auth.uid;
      }

      allow read: if isOwnerNotification() || isAdmin()
                  || (isSignedIn() && resource.data.audience == 'admin' && isAdmin());
      allow create: if false;
      allow update: if isOwnerNotification() &&
                    request.resource.data.keys().hasOnly(['read', 'updatedAt']);
      allow write, delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ§¾ Admin Logs
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /admin_logs/{logId} {
      allow read, write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â­ Reviews / Stories
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow write: if isAdmin();
    }

    match /stories/{storyId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow write: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ Refer & Earn System
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /refer_and_earn/{referralId} {
      function isReferrer() {
        return isSignedIn() && resource.data.referrerId == request.auth.uid;
      }
      function isReferred() {
        return isSignedIn() && resource.data.referredUserId == request.auth.uid;
      }

      allow read: if isReferrer() || isReferred() || isAdmin();
      allow create: if isSignedIn() &&
                    request.resource.data.referrerId == request.auth.uid &&
                    !("rewardStatus" in request.resource.data) &&
                    !("rewardAmount" in request.resource.data) &&
                    request.resource.data.keys().hasAll(["referrerId", "referredEmail", "createdAt"]);
      allow update, delete: if isAdmin();
    }

    match /referral_codes/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid) &&
                    !(exists(/databases/$(database)/documents/referral_codes/$(uid))) &&
                    request.resource.data.uid == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    match /rewards/{rewardId} {
      function isRewardOwner() {
        return isSignedIn() && resource.data.userId == request.auth.uid;
      }
      allow read: if isRewardOwner() || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    match /users/{uid}/wallet/{entryId} {
      allow read: if isSelf(uid) || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ğŸ  Homepage / Listings (Public)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    match /homepage/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /listings/{listingId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /featured_listings/{docId} {
      allow read: if true;
      allow write, delete: if isAdmin();
    }
  }
}
